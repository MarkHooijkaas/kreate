#!/bin/bash

#####################################################################
# helper functions

function info()    { ${INFO-true} && echo $*; }
function verbose() { ${VERBOSE-false} && echo $*; }
function debug()   { ${DEBUG-false} && echo $*; }
function error() { echo 1>&2 $*; exit 1; }
function nope() { verbose files created; }
export -f info
export -f verbose
export -f error

#####################################################################
# help

kreate_help() {
    cat << EOF
Usage: ${0##*/} [options] <dir>...

The purpose of kreate is calling kreate.sh to create files
and then optionally execute a command like git or kustomize
Options can be:
    -h|--help      display this help and exit
    -v|--verbose   verbose mode.
    -q|--quiet     quiet mode.
    -i|--init-file use another init file
Only one of the following commands/options should be specified:
    -s|--status   kreate temporary files, do: diff -q per file
    -d|--diff     kreate temporary files, do: diff per file
    -k|--kust     kreate files, do: kustomize build
    -a|--apply    kreate files, do: kustomize build | kubectl apply -f -
If none of the above commands are given, the files are just kreated
$KREATE_EXTRA_HELP_TEXT
EOF
}


#####################################################################
# functions to be used in kreate.sh scripts

kreate_file() {
    info kreating $(pwd)/$FILE
    #echo $(pwd)/$FILE >>$KREATED_FILES
 }
kreate_tmp_file() {
    ORIG_FILE=$FILE
    FILE=tmp.kreated.$FILE
    verbose kreating tmp file $FILE
}
kreate_diff() {
    if [[ -f $ORIG_FILE ]]; then
        info diff $ORIG_FILE
        diff $ORIG_FILE $FILE
    else
        info no original file $ORIG_FILE
    fi
    rm $FILE
    FILE=$ORIG_FILE
}
kreate_status() {
    if [[ -f $ORIG_FILE ]]; then
        verbose status $ORIG_FILE
        if diff -q $ORIG_FILE $FILE >/dev/null; then
            info . $ORIG_FILE
        else
            info M $ORIG_FILE
        fi
    else
        info + $ORIG_FILE
    fi
    rm $FILE
    FILE=$ORIG_FILE
}
export -f kreate_file
export -f kreate_tmp_file
export -f kreate_diff
export -f kreate_status

kustomize_build() {
    verbose kustomize build $1
    kustomize build $1
}
kustomize_apply() {
    info kustomize build $1 \| kubectl apply -f -
    kustomize build $1 | kubectl apply -f -
}

# default behaviour
export KREATE_FILE="kreate_file"
unset KREATE_DONE
FINAL_COMMAND=nope

#####################################################################
# initialisation
KREATE_INIT_DONE=false
kreate_init() {
    if $KREATE_INIT_DONE; then
        debug skipping init $1;
        exit 0;
    fi
    if [[ -f  $1 ]] ;then
        KREATE_INIT_DONE=true
        verbose loading init file $1
        source $1
    else
        debug init file $1 not available
    fi
}

command=files
while [ ! $# -eq 0 ]; do
    case $1 in
        -h|help|--help)
            kreate_help
            exit 0
            ;;
        -v|--verbose)
            export VERBOSE=true
            export INFO=true
            ;;
        -q|--quiet)
            export VERBOSE=false
            export INFO=false
            ;;
        -s|--status)
            export KREATE_FILE=kreate_tmp_file
            export KREATE_DONE=kreate_status
            ;;
        -d|--diff|--dry-run)
            export KREATE_FILE=kreate_tmp_file
            export KREATE_DONE=kreate_diff
            ;;
        -k|--kust|--kustomize)
            export KREATE_FILE=kreate_file
            unset KREATE_DONE
            FINAL_COMMAND=kustomize_build
            ;;
        -a|--apply)
            export KREATE_FILE=kreate_file
            unset KREATE_DONE
            FINAL_COMMAND=kustomize_apply
            ;;
        -i|--init)
            kreate_init "$2"
            shift
            ;;
        -m|--message)
            KREATE_COMMIT_MESSAGE="$2"
            shift
            ;;
        *)  # Default case: No more options, so break out of the loop.
            break
    esac
    shift
done

kreate_init $KREATE_INIT_FILE
kreate_init ./.kreate_profile
kreate_init ~/.kreate_profile
kreate_init /etc/kreate_profile


EXTRA_FILES=""
if [ $# -eq 0 ]; then EXTRA_FILES="."; fi

for f in "$@" $EXTRA_FILES
do
    if [[ -x $f/kreate.sh ]]; then
        verbose executing $f/kreate.sh
        $f/kreate.sh
        $FINAL_COMMAND $f
    else
       info Not available $f/kreate.sh
    fi
done
