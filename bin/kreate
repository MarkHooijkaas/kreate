#!/bin/bash

export KREATE_COMMIT_MESSAGE="files created/updated by kreate scripts"
show_help() {
    cat << EOF
Usage: ${0##*/} [options] <command> <dir>...

The purpose of kreate is calling kreate.sh to create files
and then optionally execute a command like git or kustomize
Options can be:
    -h|--help      display this help and exit
    -v|--verbose   verbose mode.
    -s|--silent    silent mode.
    -i|--init-file use another init file
Command can be:
    help     display this help text and exit
    files    only kreate files, no further action
    status   kreate files, do git status
    diff     kreate files, do git diff
    commit   kreate files, do git commit with commit message
             $KREATE_COMMIT_MESSAGE
    build    kreate files, do kustomize build
    apply    kreate files, do kustomize build | kubectl apply -f -
$KREATE_EXTRA_HELP_TEXT
Note: It is possible to only use the first letter(s) of a command,
as they are all unique.
EOF
}

init_files=()
command=files
while [ ! $# -eq 0 ]; do
    case $1 in
        -h|help|--help)
            command=help
            break
            ;;
        -v|--verbose)
            export VERBOSE=true
            export INFO=true
            ;;
        -s|--silent)
            export VERBOSE=false
            export INFO=false
            ;;
        -i|--init)
            init_files+=("$2")
            shift
            ;;
        -?*)
            actions+=("$1")
            ;;
        */*)  # file or directory name with a period /
            command=files
            break
            ;;
        *.*)  # file or directory name with a period .
            command=files
            break
            ;;
        *)  # Default case: No more options, so break out of the loop.
            command=$1
            shift
            break
    esac
    shift
done

declare -A commands=()
commands[help]=show_help
commands[files]=kreate_files
commands[status]=kreate_git_status
commands[commit]=kreate_git_commit
commands[diff]=kreate_git_diff
commands[apply]=kustomize_apply
commands[build]=kustomize_build


init_files+=($KREATE_INIT_FILE)
init_files+=(./.kreate_profile)
init_files+=(~/.kreate_profile)
init_files+=(/etc/kreate_profile)
for f in "${init_files[@]}"; do
    if [[ -f  $f ]] ;then
        ${INFO-true} && echo loading init file $f
        source $f
    else
        ${VERBOSE-false} && echo skipping init file $f
    fi
done

kreate_files() { ${VERBOSE-false} && echo created files, no more actions; }
kreate_git_status() { git status $1; }
kreate_git_diff() { git diff $1; }
kreate_git_commit() { git commit $1 -m "$KREATE_COMMIT_MESSAGE"; }
export -f kreate_git_commit
export -f kreate_git_status
export -f kreate_git_diff

kustomize_apply() {
    ${INFO-true} && echo kustomize build $1 \| kubectl apply -f -
    kustomize build $1 | kubectl apply -f -
}
kustomize_build() {
    ${INFO-true} && echo kustomize build $1
    kustomize build $1
}

EXTRA_FILES=""
if [ $# -eq 0 ]; then EXTRA_FILES="."; fi

for f in "${!commands[@]}"; do
    if [[ "$f" == "$command"* ]]; then
        command=$f
        KREATE_COMMAND=${commands[$command]}
        ${INFO-true} && echo kreate $command $* $EXTRA_FILES
    fi
done
if [[ "$command" == "help" ]]; then
    show_help
    exit 0
fi


for f in $* $EXTRA_FILES
do
    if [[ -x $f/kreate.sh ]]; then
        ${INFO-true} && echo Starting $f/kreate.sh
        $f/kreate.sh
        $KREATE_COMMAND $f
    else
        ${INFO-true} && echo Not available $f/kreate.sh
    fi
done
